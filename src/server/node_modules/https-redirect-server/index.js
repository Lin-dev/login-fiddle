'use strict';

var http = require('http');

module.exports = function(port, securePort) {

  var createRedirectURL = function(hostname, url) {
    var secureHostname;

    if (securePort === 443) {
      secureHostname = hostname;
    } else { // host.com -> host.com:securePort
      secureHostname = hostname + ':' + securePort; 
    }


    return 'https://' + secureHostname + url;
  };

  return {
    server: function() { // start server to redirect all traffic
      var server = http.createServer(function(request, response) {
        var host = request.headers.host
        var index = request.headers.host.indexOf(':');
        var hostname = index === -1 ? host : host.substring(0, index);
        var redirectURL = createRedirectURL(hostname, request.url);

        response.writeHead(302, {'Location': redirectURL});
        response.end();
      });

      server.listen(port);
      console.log('HttpsRedirectServer redirecting from ' + port + ' to ' + securePort);
    },
    forceSecure: function(req, res, next) {
      if (req.secure) {
        next();
      }

      var redirectURL = createRedirectURL(req.hostname, req.url);
      res.redirect(redirectURL);
    }
  };
};